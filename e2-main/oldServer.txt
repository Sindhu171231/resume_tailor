const express = require("express");
const cors = require("cors");
const fetch = (...args) => import("node-fetch").then(({ default: fetch }) => fetch(...args));
const FormData = require("form-data");

const app = express();
const AUTH_API = "https://authentication-8e1c.onrender.com/auth";

app.use(cors({ origin: "http://127.0.0.1:5500" }));
app.use(express.json());

app.post("/auth", async (req, res) => {
  try {
    console.log("ðŸ“© Incoming request body:", req.body);

    // Build form-data payload
    const formData = new FormData();
    formData.append("email", req.body.email);
    formData.append("password", req.body.password);
    formData.append("action", req.body.action);

    console.log("ðŸš€ Forwarding body to API as form-data");

    const response = await fetch(AUTH_API, {
      method: "POST",
      body: formData,
    });

    const data = await response.json();
    console.log("ðŸ“¤ Response status:", response.status);
    console.log("ðŸ“¤ Response body:", data);

    res.status(response.status).json(data);
  } catch (err) {
    console.error("âŒ Proxy error:", err);
    res.status(500).json({ message: "Auth service unavailable", error: err.message });
  }
});

const PORT = 4000;
app.listen(PORT, () =>
  console.log(`âœ… Proxy server running at http://localhost:${PORT}`)
);
----------------

const express = require("express");
const cors = require("cors");
const fetch = (...args) =>
  import("node-fetch").then(({ default: fetch }) => fetch(...args));
const FormData = require("form-data");
const mongoose = require("mongoose");
const multer = require("multer");

const app = express();
const AUTH_API = "https://authentication-8e1c.onrender.com/auth";

// ====== MongoDB Setup ======
const MONGO_URI =
  "mongodb+srv://sasinew49_db_user:TcFkmDIaiccTDO3W@cluster-resumeproject.6dhm1e9.mongodb.net/resumeDB?retryWrites=true&w=majority&appName=Cluster-ResumeProject"; // replace with your DB name

mongoose
  .connect(MONGO_URI)
  .then(() => console.log("âœ… MongoDB connected"))
  .catch((err) => console.error("âŒ MongoDB error:", err));

// ====== Schema & Model ======
const ResumeSchema = new mongoose.Schema({
  email: { type: String, required: true, unique: true },
  file: { data: Buffer, contentType: String },
  originalFileName: { type: String },
  uploadedAt: { type: Date, default: Date.now },
});

// force collection = "resumes"
const Resume = mongoose.model("Resume", ResumeSchema, "resumes");

// ====== Middlewares ======
app.use(cors({ origin: "http://127.0.0.1:5500" }));
app.use(express.json());

const storage = multer.memoryStorage();
const upload = multer({ storage });

// ====== Auth Proxy ======
app.post("/auth", async (req, res) => {
  try {
    const formData = new FormData();
    formData.append("email", req.body.email);
    formData.append("password", req.body.password);
    formData.append("action", req.body.action);

    const response = await fetch(AUTH_API, { method: "POST", body: formData });
    const data = await response.json();
    res.status(response.status).json(data);
  } catch (err) {
    console.error("âŒ Auth error:", err);
    res
      .status(500)
      .json({ message: "Auth service unavailable", error: err.message });
  }
});

// ====== Resume Upload ======
app.post("/resume/upload", upload.single("resume"), async (req, res) => {
  try {
    const { email } = req.body;
    if (!email || !req.file) {
      return res.status(400).json({ error: "Email and resume required" });
    }

    const resume = await Resume.findOneAndUpdate(
      { email },
      {
        file: { data: req.file.buffer, contentType: req.file.mimetype },
        originalFileName: req.file.originalname,
        uploadedAt: new Date(),
      },
      { upsert: true, new: true }
    );

    res.json({ message: "âœ… Resume uploaded successfully", resume });
  } catch (err) {
    console.error("âŒ Upload error:", err);
    res.status(500).json({ error: "Failed to upload resume" });
  }
});

// ====== Fetch Jobs ======
app.post("/fetchJobs", upload.single("resume"), async (req, res) => {
  try {
    let resumeBuffer;

    if (req.file) {
      resumeBuffer = req.file.buffer;
    } else if (req.body.email) {
      const resume = await Resume.findOne({ email: req.body.email });
      if (!resume) {
        return res.status(404).json({ error: "Resume not found" });
      }
      resumeBuffer = resume.file.data;
    } else {
      return res.status(400).json({ error: "Resume or email required" });
    }

    const formData = new FormData();
    formData.append("file", resumeBuffer, { filename: "resume.pdf" });

    const response = await fetch(
      "https://eday-project.onrender.com/api/v1/alerts/upload?top_k=3",
      { method: "POST", body: formData }
    );

    const data = await response.json();
    res.json(data);
  } catch (err) {
    console.error("âŒ FetchJobs error:", err);
    res.status(500).json({ error: "Failed to fetch jobs" });
  }
});

// ====== Start Server ======
const PORT = 4000;
app.listen(PORT, () =>
  console.log(`âœ… Server running at http://localhost:${PORT}`)
);
